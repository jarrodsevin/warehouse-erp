generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // ADD THIS LINE
}

// Keep all your existing models below (Category, Subcategory, Brand, etc.)

model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model Subcategory {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model Brand {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model Vendor {
  id             String          @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  contactPerson  String?
  status         String          @default("active")
  notes          String?
  purchaseOrders PurchaseOrder[] // ADD THIS LINE
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Customer {
  id                String        @id @default(cuid())
  name              String
  email             String?
  phone             String?
  address           String?

  customerGroup     String
  customerCategory  String

  creditLimit       Float         @default(0)
  currentBalance    Float         @default(0)
  paymentTerms      String?

  status            String        @default("active")
  notes             String?

  salesOrders       SalesOrder[]
  payments          Payment[]
  salesVisits   SalesVisit[]

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model Product {
  id                String        @id @default(cuid())
  sku               String        @unique
  name              String
  description       String?
  cost              Float
  retailPrice       Float
  floorPrice        Float?        // Minimum selling price (cost * 1.15)
  categoryId        String
  category          Category      @relation(fields: [categoryId], references: [id])
  subcategoryId     String?
  subcategory       Subcategory?  @relation(fields: [subcategoryId], references: [id])
  brandId           String?
  brand             Brand?        @relation(fields: [brandId], references: [id])
  unitOfMeasurement String?
  packageSize       Float?
  casePackCount     Int?
  storageType       String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  purchaseOrderItems PurchaseOrderItem[]
  salesOrderItems   SalesOrderItem[]
  changeLogs        ProductChangeLog[]
  inventory         Inventory?
}

model ProductChangeLog {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  changeType  String
  oldCost     Float?
  newCost     Float?
  oldRetail   Float?
  newRetail   Float?
  oldMargin   Float?
  newMargin   Float?
  oldDescription String?
  newDescription String?
  changedAt   DateTime @default(now())

  @@index([productId])
  @@index([changedAt])
}

model Inventory {
  id              String   @id @default(cuid())
  productId       String   @unique
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantityOnHand  Int      @default(0)
  reorderLevel    Int      @default(0)
  reorderQuantity Int      @default(0)
  currentCost     Float    @default(0)
  lastCostUpdate  DateTime?
  lastRestocked   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([productId])
}

model PurchaseOrder {
  id            String              @id @default(cuid())
  poNumber      String              @unique
  vendorId      String
  vendor        Vendor              @relation(fields: [vendorId], references: [id])
  orderDate     DateTime            @default(now())
  expectedDate  DateTime?
  receivedDate  DateTime?
  status        String              @default("pending")
  notes         String?
  items         PurchaseOrderItem[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation(fields: [productId], references: [id])
  quantity        Int
  unitCost        Float
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model SalesOrder {
  id                String            @id @default(cuid())
  soNumber          String            @unique

  customerId        String
  customer          Customer          @relation(fields: [customerId], references: [id])

  orderDate         DateTime          @default(now())

  status            String            @default("fulfilled")

  subtotal          Float
  total             Float

  notes             String?

  // NEW: Order Acceptance Fields
  orderAccepted     Boolean           @default(false)
  printedName       String?
  signature         String?           @db.Text
  acceptedAt        DateTime?

  items             SalesOrderItem[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model SalesOrderItem {
  id                String        @id @default(cuid())

  salesOrderId      String
  salesOrder        SalesOrder    @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  productId         String
  product           Product       @relation(fields: [productId], references: [id])

  quantity          Int
  unitPrice         Float
  lineTotal         Float

  createdAt         DateTime      @default(now())
}

model Payment {
  id                String        @id @default(cuid())

  customerId        String
  customer          Customer      @relation(fields: [customerId], references: [id])

  amount            Float
  paymentDate       DateTime      @default(now())
  paymentMethod     String?
  referenceNumber   String?

  notes             String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}
model SalesVisit {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])
  visitDate   DateTime @default(now())
  notes       String?  @db.Text
  images      String?  @db.Text  // Stores JSON array of base64 images
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([customerId])
  @@index([visitDate])
}
model ScheduledReportBatch {
  id              String                 @id @default(cuid())
  name            String                 // User-defined name like "Weekly Executive Summary"
  userName        String                 // Name of person receiving report
  emailAddress    String                 // Email to send to
  status          String                 @default("draft") // "draft" or "active"
  frequency       String                 // "daily", "weekly", "monthly"
  scheduledDays   String?                // JSON array of days for weekly (e.g., ["Monday", "Friday"])
  scheduledTime   String                 @default("09:00") // Time to send (HH:MM format)
  timezone          String            @default("America/Chicago")
  lastSentAt      DateTime?              // Last time report was sent
  nextScheduledAt DateTime?              // Next scheduled send time
  items           ScheduledReportItem[]  // Reports in this batch
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  @@index([status])
  @@index([nextScheduledAt])
}

model ScheduledReportItem {
  id                     String                @id @default(cuid())
  batchId                String
  batch                  ScheduledReportBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  reportType             String                // "product-profitability", "category-analysis", etc.
  orderIndex             Int                   // Position in the batch (for drag-and-drop ordering)
  filterConfig           String                @db.Text // JSON string of filter settings
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt

  @@index([batchId])
  @@index([orderIndex])
}